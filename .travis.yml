#####################################################
# heimdall-webapp build script for TravisCI
#
# Builds, tests, packages, and deploys the Node app
# to AWS on every code commit.
#
# author: Johnny Mohseni
#####################################################
language: node_js
node_js: 4.4.3
cache:
  directories: node_modules
env:
  global:
    - secure: ZISrC+n/GHsMXI5YoddKs78vK2WmkCCt5VYrC8cmXtx3pytDRf9hKomqxh3BpoqAQc5tBuMSS5jDIC+mxnplI4z/rORSMvo/aM2i3i33//vkKOrVDZi5buKnoaTBzQLHZHTI69xPkSk0H0lWGEZZPdYrsJ+OlSbsk+vQXq9rztg/G2Btohhk+5plW33CoorjxXl/r0V4zDC4E7eYS+2KJUJ/VOhLQcm6LafkjKM3RetWByUMz1Qy1iuhmLCuG4au4Frw7hAFHRTldGK+xsL3wER14k93rv5j7kC2fQC0zEEHHvIL0uu5kKLJOCt2qLY+nxz/mVagJb+3rP6h8NOFvwoTQ2qH8SQChjF08Sv/q1pi74IVyhburG08Ln2CtxEWpPDHH4O4XYTujhg4dw5NEjgogA8H80hVmCAD3QWQSPU8MxCfGW6JYR7/Hz08DaDoenNC6RDRrT96H9R0EWO3Cokd0WjcNfF4eXxxPCxh4HZhBGu4RQCosImTMtPNK+RQMCtZIlV9a03SBfW3+gbEcQ7t2iQLKiq9Pa1WVwLxBm0BLn+IMA9tSZ7DVsqcSIXOs32BXyU9tAuvW2zZGNNQ4GNlehz4RLZ8H77+5CJt/OGL59ipH6LcXk+PspjthZUXNt+SPGPZOfZj2MXeCXuvxd1osZecXEEgk+efsgoMCFI=
install:
  - npm install -g gulp
  - npm install -g jspm
  - npm install -g coveralls
  - npm install -g strongloop
  - cd client
  - npm install
  # GitHub Token needed to avoid GitHub API Rate Limit Thresholds
  - jspm config registries.github.auth $JSPM_GITHUB_AUTH_TOKEN
  - jspm install -y
  - cd ..
script:
  - cd client
  - gulp build
  - cd ..
  - slc build --install
before_deploy:
  # This section runs PER PROVIDER listed in the deploy section.  This means
  # idempotent behavior for all these steps is required in order to avoid
  # insidious bugs and unwanted side-effects.
  - zip -rq heimdall-webapp-1.0.0.zip * -x 'node_modules' -x 'client/node_modules'
  - mkdir -p dpl_cd_upload
  - mv heimdall-webapp-1.0.0.zip dpl_cd_upload/heimdall-webapp-1.0.0.zip
deploy:
  - skip_cleanup: true
  - provider: s3
    access_key_id: &1
      secure: VQRWV2OHpQtS9J+EVKPmZk4NfORoaWmI9BwD3QLo+ih1/H+qp6zGPWPC7nI9bk4x6j+wpoTbFOBy29UB41bm4O84+/Uo52B1lBYAmPQhX/IBeB5/VdWPavZ0p1nTZU2BW2/6TGH+uhtzrHrlncMeXa9E9PUcYTlTMzAUNCvduYTTALjK29PC6QE/iz8f2V+7TFX3sVa+SSvoTzADe3TKfa29nOWbgb+ICFwcjzmEv5wBe1JPniiLGU5h127BrQaFEOsDk5YhTB4yHQHgDgRd08KhEBpklwxptV0x1Cb4Fe5k0E9CV7ZF2QokzqACdu9YMDGyA3q2s+6QwzfXEzS7/HXUr3Upv5wqGjNEeSZWKPl59uL18WUq9gHRxvSxeYJSsSZHl25Cue1qV0KhT1E+L1eAqUgy3Q5S8zCfAhuRmbnowPtINrJ6UYDNLSMQP4y7fqEvwA1FEB1QjKpMmAe5Tx260r5z+o6GlpL/uk0UgD7LIoDmULiWQbXf3gcMinboihBaDwKUocKlx2KW5sW+PaYD9xK4qTmJBynnU7AORWs8ZOT1E6dXubXgpL/aMQpMH9NCQtQlfBDl4cRel9VMwO5soDkBy6m+jxWIGS4WG+FlqLFxiArMEEv+nbY6E3PaWUg3GMWz5saJ2HP9v29b6vmjaP7bxH+qnKjrSFF9udM=
    secret_access_key: &2
      secure: RIQ+/PKF1Ut+UIjQ9a0iyWwAuOUCXQIS634vkUVnL1i7GIxgrFk5Z2+LhpF4+VXM97cMyfLrqpZtN4ItIKbH+jNkcIkNVCP1DffsFtP5RQWCorPgyU6JqJGWMnE2gIDiQ6YjXMlFAzyR6G2wXJsJ9Cvz4EDbiBdJKxkMEPB+ptzAGgVxmxpxSRHvnA87M4Szy+SlbyuDjNFQO/R4wdY1KeNbdd6o4TkcD5l5rni4T0AHFUQBfeQerCe6yvUVbx1tYGb7gdR+aEI+qbz+8NhnLPuTV31pDmmSLYMPuE9HqH/kTd1dOe/+zcPmH1wtRs4O8vh4EbTfcHeniJGNxXdxiHInQAY/WD5pNoRFdGIYZK2AX5Jx4h4FTl/b2GSBre5sDHY7CXE9UbpEvX4Bg9eURF8RijRIseL1w8oayHYt8F+QJl86qT06PYpCbufw4EmUKg+gFYqZHn0I6XDlTTReSPwnvsMMX3EMLE9bX1NSa/iEmbyX/Eer8ruHM3p9jqzV+Co2JFSO3cVPNbTQVRYqRG3x1aQ5wUl9PdOwVDdLfDUQVkNl81KLpbxUTOPR4e+SLu/o0rlGhfP4FbvbmymQ9prTkuBBAI+joFW5SR+7pwLN2N+DUG5IFt5tfQ6DKiC1qkJKgthTtMeJNOZBH6+RbkrNq5iaygCuXY0cghPpKho=
    local_dir: dpl_cd_upload
    on: &3
      repo: Project-Heimdall/heimdall-webapp
      branch: master
    bucket: codedeploy-heimdall-webapp
    region: us-west-2
  - provider: codedeploy
    access_key_id: *1
    secret_access_key: *2
    bucket: codedeploy-heimdall-webapp
    key: heimdall-webapp-1.0.0.zip
    bundle_type: zip
    application: CodeDeploy-HeimdallWebapp
    deployment_group: CodeDeploy-HeimdallWebapp-Group
    region: us-east-1
    on: *3
